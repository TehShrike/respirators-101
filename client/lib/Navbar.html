<nav>
	<button class="menu open" on:click="set({visible: true})"></button>
</nav>

{{#if visible}}
<div class="anythingelsebutton" on:click="set({visible: false})"></div>
{{/if}}

<div class="slide-out" data-visible="{{visible}}">

	<button class="menu close" on:click="set({visible: false})"></button>

	<ul class="links">
		{{#each navigation as item}}

		<li>
		
			{{#if item.children}}
				
			<Category :item :closeAllExpands :registerExpand>
				<ul>
					{{#each item.children as page}}
					<li>
						<a href="{{ asr.makePath('wrapper.app.content', { id: page.id }) }}">{{page.name}}</a>
					</li>
					{{/each}}
				</ul> 
			</Category>

			{{else}}

			<a href="{{ asr.makePath('wrapper.app.content', { id: item.id }) }}">{{item.name}}</a>

			{{/if}}

		</li>

		{{/each}}
	</ul>

	{{#if !visible}}
	<div class="debutterfinger"></div>
	{{/if}}

</div>

<script>

	import Category from 'lib/Category.html'

	import navTree from 'data/navigation.json'
	import idToName from 'data/id-to-name.json'

	const navigation = navTree.map(e => {
		return {
			id: e.id,
			title: e.title,
			children: e.children.map(id => ({
				id,
				name: idToName[id],
			}))
		}
	})

	export default {
		components: {
			Category
		},
		oncreate() {

			document.querySelectorAll('.expand').forEach(e => {
				e.style.height = e.clientHeight + 'px'
				e.setAttribute('class', 'expand initialized')
			})

		},
		// until https://github.com/sveltejs/svelte/issues/881 lands, this is the best way to do dynamic refs that I can think of
		data() {
			var expands = []
			return { 
				visible: false,
				navigation,
				closeAllExpands() {
					expands.forEach(e => {
						e._set({ open: false })
					})
				},
				registerExpand(expand) {
					expands.push(expand)
				}
			}
		}
	}

</script>

<style>

	@import "colors";
	
	nav {
		width: 100%;
		height: 50px;
		background: $blue3;
	}

	button.menu {
		float: right;
		width: 50px;
		height: 50px;
		display: block;
		border: 0;
		cursor: pointer;
		background-color: $blue3;
		background-size: 70%;
		background-repeat: no-repeat;
		background-position: center;

		&.open {
			background-image: url('icons/menu.svg');
		}
		&.close {
			background-image: url('icons/x.svg');
		}
	}

	.anythingelsebutton, .debutterfinger {
		position:absolute;
		top:0;
		right:0;
		bottom:0;
		left:0;
		z-index: 1;
	}

	.slide-out {
		position:absolute;
		top:0;
		right:0;
		width: 100%;
		max-width: 400px;
		bottom:0;
		z-index: 2;
		background: $blue3;
		transition: all .2s ease;
		color: #fff;
		box-shadow: 0px 0px 50px #00000066;
		font-size: 14px;

		&[data-visible=false] {
			right: calc(-100% - 50px);
		}

		&[data-visible=true] {
			right: 0;
		}

		.links {
			margin-top: 50px;
		}

		ul, li {
			list-style: none;
			display: block;
			padding: 0;
			margin: 0;
		}

		.category-title {
			background: $blue4;
			display: block;
			padding: 0 0 0 20px;
			line-height: 50px;
			border-top: 1px solid $blue3;
			border-bottom: 1px solid $blue5;

			&::after {
				display: block;
				float: right;
				width: 50px;
				height: 50px;
				background-size: 50%;
				background-repeat: no-repeat;
				background-position: center;
				background-image: url('icons/chevron-down.svg');
				content: ' ';
				transition: transform .2s ease-out;
			}
		}

		.category[data-open=true] .category-title::after {
			transform: rotate(-180deg);
		}

		.expand {
			background: $blue5;

			&> ul {
				padding-bottom: 10px;
			}
		}

		a {
			color: #fff;
			display: block;
			line-height: 20px;
			text-decoration: none;
			padding: 10px 20px 10px 40px;

			&:hover {
				background: #00000066;
			}
		}

	}

</style>